name: Reusable NPM Workflow

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
      workingDir:
        required: true
        type: string
      verbose:
        required: false
        type: boolean
        default: false
      customCommand:
        required: false
        type: string
      customRegistry:
        required: false
        type: string

jobs:
  npm-task:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check and Install npm
        run: |
          echo Checking npm installation...
          npm -v >nul 2>&1
          if %ERRORLEVEL% NEQ 0 (
            echo npm is not installed. Installing npm via Chocolatey...
            choco install nodejs-lts -y
            echo npm installed. Verifying npm installation...
            npm -v >nul 2>&1
            if %ERRORLEVEL% NEQ 0 (
              echo npm installation failed. Exiting workflow...
              exit /b 1
            ) else (
              echo npm installation successful. npm version:
              npm -v
            )
          ) else (
            echo npm is already installed. npm version:
            npm -v
          )
        shell: cmd

      - name: Debug Node.js and npm Installation
        run: |
          echo Node.js and npm versions: 
          node -v && npm -v
        shell: cmd

      - name: List Files in Working Directory
        run: |
          cd ${{ inputs.workingDir }}
          dir
        shell: cmd

      - name: Verify Working Directory Contains package.json
        run: |
          cd ${{ inputs.workingDir }}
          if exist "package.json" (
            echo Success: package.json found in the specified working directory: ${{ inputs.workingDir }}
          ) else (
            echo Error: package.json not found in the specified working directory: ${{ inputs.workingDir }}
            exit /b 1
          )
        shell: cmd

      - name: Configure Custom Registry
        if: ${{ inputs.customRegistry != '' }}
        working-directory: ${{ inputs.workingDir }}
        run: |
          echo registry=${{ inputs.customRegistry }} >> .npmrc
        shell: cmd

      - name: Run NPM or Custom Command
        working-directory: ${{ inputs.workingDir }}
        run: |
          if "${{ inputs.command }}"=="custom" (
            if "${{ inputs.customCommand }}"=="" (
              echo Error: customCommand input is required when command is "custom"
              exit 1
            ) else (
              echo Running Custom Command: ${{ inputs.customCommand }}
              ${{ inputs.customCommand }}
            )
          ) else if "${{ inputs.verbose }}"=="true" (
            echo Running npm ${{ inputs.command }} --verbose
            npm ${{ inputs.command }} --verbose
          ) else (
            echo Running npm ${{ inputs.command }} --Without Verbose
            npm ${{ inputs.command }}
          )
        shell: cmd

